
YUI.add('ysf-xhr',function(Y){var XHR_proto,XHR_static;function YSFXHR(config){YSFXHR.superclass.constructor.apply(this,arguments);}
YSFXHR.NAME='xhr';YSFXHR.ATTRS={'autoRegister':{'value':true},'isRegistered':{'value':false},'eventType':{'value':'click','valueFn':function(){if(this.get('form')){return'submit';}}},'form':{'value':null},'el':{'value':null},'callbackObj':{'value':{'success':function(cId,response){Y.log('Connection '+cId+': success','info','Y.Fantasy.XHR');},'failure':function(cId,response){Y.log('Connection '+cId+': failure','error','Y.Fantasy.XHR');}}},'triggers':{'value':[],'setter':function(triggers,fullname){var triggersAr=[];if(Y.Lang.isArray(triggers)||triggers instanceof Y.NodeList){Y.each(triggers,function(thisTrigger){var triggerNode=Y.one(thisTrigger);if(triggerNode){triggersAr.push(triggerNode);}});}else{if(triggers===Y){triggersAr.push(triggers);}else{triggersAr.push(Y.one(triggers));}}
return triggersAr;}},'triggerDelegate':{value:null},'triggerHandler':{'value':function(e,obj){var connection;try{if(obj.get('form')){connection=obj.submit(this);}else{connection=obj.fetch(this);}
if(connection){e.preventDefault();}}catch(err){Y.log(err);}}},'activeConnection':{value:null},'lastHash':{value:null}};XHR_proto={initializer:function(cfg){if(this.get('autoRegister')){this.register();}},destructor:function(){this.detachTriggers();},detachTriggers:function(){var triggers=this.get('triggers');Y.Array.each(triggers,function(trigger){trigger.detach('ysfxhr|*');});},register:function(){if(this.get('form')){this.set('triggers',this.get('form'));}
var triggers=this.get('triggers'),delegate=this.get('triggerDelegate'),eventType=this.get('eventType'),eventTypes=Y.Lang.isArray(eventType)?eventType:[eventType],self=this;Y.Array.each(eventTypes,function(evt){Y.Array.each(triggers,function(trigger){if(Y.Lang.isString(delegate)){trigger.delegate('ysfxhr|'+evt,self.get('triggerHandler'),delegate,null,self);}else{trigger.on('ysfxhr|'+evt,self.get('triggerHandler'),null,self);}});});this.set('isRegistered',true);},parseResponse:function(cId,resp){var obj=null;if(resp.responseText){try{obj=Y.JSON.parse(resp.responseText);this.checkForErrors(cId,obj);obj.contentIsNew=this.checkContentHash(cId,obj);}catch(e){Y.log('Error parsing ajax','error','ysf-xhr');Y.log(e);if(Y.Af&&Y.Af.Beacon){Y.Af.Beacon.error('ysf-xhr',{'connection':cId},{code:'parseError',message:'error parsing XHR JSON response'});}}}
return obj;},_errorMap:{},hasErrors:function(cId){return this._errorMap[cId].hasErrors||false;},getErrors:function(cId){var errors=null;if(this.hasErrors(cId)){errors=this._errorMap[cId].errors;}
return errors;},checkForErrors:function(cId,obj){var errorRef={'hasErrors':false,'errors':[]},x;this._errorMap[cId]=errorRef;if(obj&&Y.Lang.isArray(obj.errors)&&obj.errors.length){for(x=0;x<obj.errors.length;x+=1){if(obj.errors[x].code){errorRef.hasErrors=true;errorRef.errors.push(obj.errors[x]);}}}
return errorRef;},checkContentHash:function(cId,obj){var oldHash=this.get('lastHash'),newHash=obj.hash,canCompare=true,updateHash=true;if(!Y.Lang.isString(oldHash)||oldHash===''){canCompare=false;}
if(canCompare&&(!Y.Lang.isString(newHash)||newHash==='')){canCompare=false;updateHash=false;}
if(updateHash){this.set('lastHash',newHash);}
return canCompare?oldHash!==newHash:true;},fetch:function(el,href,sync){var self=this,connection,fetchHref=Y.Lang.isString(href)?href:el.getAttribute('href'),cfg={};if(el){el.addClass('loading');}
if(sync){cfg.sync=true;}
connection=Y.Fantasy.XHR.fetchFromAjaxWithCfg(cfg,fetchHref,this.get('callbackObj'),el,self,true);this.set('activeConnection',connection);return connection;},submit:function(form){var self=this,connection;connection=Y.Fantasy.XHR.submitToAjax(form,this.get('callbackObj'),null,self);this.set('activeConnection',connection);return connection;}};XHR_static={transactionMap:[],addTransaction:function(connection,el){var n=el?Y.one(el):null;Y.Fantasy.XHR.transactionMap[connection.id]=n;},getTransaction:function(connection){var cId=Y.Lang.isObject(connection)?connection.id:connection;return Y.Fantasy.XHR.transactionMap[cId];},fetchFromAjaxWithCfg:function(cfg,href,callback,triggerEl,context,asGet){var XHRMethod=asGet?'GET':'POST',base,query,queryobj,hrefFrags,queryAr,connection,x,io_cfg=Y.Lang.isObject(cfg)?cfg:{};io_cfg.headers=io_cfg.headers||{};io_cfg.headers['Ajax-Request']='true';try{if(XHRMethod==='GET'){base=href.replace(/(\#.*)$/,'');query=null;base+=(/\?/.test(base))?'&':'?';base+='ajaxrequest=1';}else{hrefFrags=href.split('?');base=hrefFrags[0];query=null;if(hrefFrags.length>1){queryAr=[];for(x=1;x<hrefFrags.length;x+=1){queryAr[queryAr.length]=hrefFrags[x];}
query=queryAr.join(encodeURIComponent('?'));queryobj=Y.QueryString.parse(query);io_cfg.data=io_cfg.data||{};io_cfg.data=Y.QueryString.stringify(Y.merge(io_cfg.data,queryobj),{arrayKey:true});}}
io_cfg.method=XHRMethod;io_cfg.on=callback;if(context){io_cfg.context=context;}
connection=Y.io(base,io_cfg);Y.Fantasy.XHR.addTransaction(connection,triggerEl);callback.connections=callback.connections||{};callback.connections[connection.id]=connection;if(triggerEl){callback.triggered=callback.triggered||{};callback.triggered[connection.id]=triggerEl;}
if(callback.onConnect&&typeof callback.onConnect==='function'){callback.onConnect(connection,href);}
return connection;}catch(e){Y.log(e,'error','fetchFromAjax');return false;}},fetchFromAjax:function(href,callback,triggerEl,context,asGet){return Y.Fantasy.XHR.fetchFromAjaxWithCfg(null,href,callback,triggerEl,context,asGet);},submitToAjax:function(formref,callback,validationFunc,context,triggerEl){var form=Y.one(formref),isValid=true,connection,io_cfg={'headers':{'Ajax-Request':'true'},'form':{'id':form},'method':'POST'};if(Y.Lang.isFunction(validationFunc)){isValid=validationFunc(form);}
if(isValid){try{io_cfg.on=callback;if(context){io_cfg.context=context;}
connection=Y.io(form.getAttribute('action'),io_cfg);callback.connections=callback.connections||{};callback.connections[connection.id]=connection;callback.submitted_forms=callback.submitted_forms||{};callback.submitted_forms[connection.id]=form;Y.Fantasy.XHR.addTransaction(connection,form);return connection;}catch(e){Y.log(e,'error','submitToAjax');return false;}}else{return false;}}};Y.extend(YSFXHR,Y.Base,XHR_proto,XHR_static);Y.namespace('Fantasy');Y.Fantasy.XHR=YSFXHR;},'0.2',{'requires':['io-base','io-form','base','node','json-parse','querystring-stringify-simple','querystring-parse-simple']});