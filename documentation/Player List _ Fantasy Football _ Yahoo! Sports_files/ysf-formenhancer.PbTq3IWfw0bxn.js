
YUI.add('ysf-formenhancer',function(Y){Y.namespace('Fantasy');var FantasyFormEnhancer=function(){};FantasyFormEnhancer.prototype={initComplete:false,onInitComplete:new Y.CustomEvent('onInitComplete'),formEvtMap:{},_defSubmitFn:function(e,obj){if(e.form){e.form.submit();}},_defResetFn:function(){},_defButtonFn:function(){},valid_tabindex_els:{'A':true,'AREA':true,'BUTTON':true,'INPUT':true,'OBJECT':true,'SELECT':true,'TEXTAREA':true},init:function(){var i,forms,this_form,this_form_id,new_inputs={},new_id,ext;this.ext=(Y.one('.yst-all'))?'yfa':'ysf';forms=Y.all('form');this.publish('submit',{emitFacade:true,defaultFn:Y.bind(this._defSubmitFn,this)});this.publish('reset',{emitFacade:true,defaultFn:Y.bind(this._defResetFn,this)});this.publish('button',{emitFacade:true,defaultFn:Y.bind(this._defButtonFn,this)});forms.each(function(node){new_id=node.generateID();this.appendJSEnabledInput(node);new_inputs=this.enhanceFormCTAs(node);if(document.all){this.appendFormCTAInputs(new_inputs,node);}
if(node.hasClass(this.ext+'-form')){this.applyTabIndexes(node);}
Y.Fantasy.FantasyFormEnhancer.formEvtMap[node.get('id')]={'submit':{'subscribe':function(fn,ctx){Y.Fantasy.FantasyFormEnhancer.on('submit',Y.bind(function(e,obj){if(e.form.get('id')===this.get('id')){if(fn.call(ctx)===false){e.preventDefault();}}},node));}},'reset':new Y.CustomEvent('cancel'),'button':new Y.CustomEvent('button')};},this);this.postInit();},isTabIndexEl:function(el){if(Y.FantasyFormEnhancer.valid_tabindex_els[el.get('tagName').toUpperCase()]){return true;}
return false;},applyTabIndex:function(el){if(el.getAttribute('type')!=='hidden'&&(el.tabIndex===null||el.tabIndex===0)){el.tabIndex=0;}},applyTabIndexes:function(el){try{this.applyTabIndex(el);}catch(e){Y.log(e);}},postInit:function(){this.initComplete=true;Y.fire('onInitComplete:ready');},appendJSEnabledInput:function(elForm){if(elForm.hasClass(this.ext+'-form')){var new_input,form_id=elForm.get('id');new_input=Y.Node.create('<input>');new_input.setAttrs({'id':form_id+'-jsenabled','name':'jsenabled','value':'1','type':'hidden'});elForm.appendChild(new_input);}},enhanceFormCTAs:function(form){var new_inputs={},elForm=Y.one(form),this_form_id=elForm.get('id'),ctas=Y.all('#'+this_form_id+' input.'+this.ext+'-cta');ctas.each(function(cta){var cta_name=this.enhanceFormCTAEl(cta,elForm);if(!new_inputs[cta_name]){new_inputs[cta_name]=cta_name;}},this);return new_inputs;},enhanceFormCTAEl:function(el,form){try{var cta_name=el.getAttribute('name'),cta_value=el.get('value'),cta_id=el.generateID(),cta_class=el.getAttribute('class'),cta_text=el.getAttribute('title')||cta_value,cta_type=el.getAttribute('type'),oCta={'cta_name':cta_name,'cta_value':cta_value,'cta_type':cta_type,'elForm':form},new_anchor;if(cta_type&&cta_type.toLowerCase()==='button'){if(el.hasClass(this.ext+'-cta-reset')){oCta.cta_type='reset';}}
new_anchor=this.generateCTAButton(cta_id,cta_class,cta_text);new_anchor.on('click',this.handleCTAClick,this,oCta);new_anchor.on('keyup',this.handleFormKeyup,this,oCta,new_anchor);el.get('parentNode').insertBefore(new_anchor,el);this.transformCTAInput(el,form);return cta_name;}catch(e){Y.log(e);}},generateCTAButton:function(id,className,text){var new_anchor=Y.Node.create('<a>');new_anchor.setAttrs({'id':id,'className':className,'innerHTML':text,'href':'#'});return new_anchor;},transformCTAInput:function(el,form){var form_id=form.getAttribute('id'),existing_el=Y.one('#'+form_id+'-'+el.get('name'));if(!document.all&&!existing_el){el.set('type','hidden');el.set('value','');el.set('id',form_id+'-'+el.getAttribute('name'));}else{el.get('parentNode').removeChild(el);}},appendFormCTAInputs:function(new_inputs,form){var form_id=form.get('id'),new_input,i;for(i in new_inputs){if(new_inputs.hasOwnProperty(i)){new_input=Y.Node.create('<input>');new_input.setAttrs({'id':form_id+'-'+new_inputs[i],'name':new_inputs[i],'type':'hidden'});form.appendChild(new_input);}}},updateHiddenInputValue:function(obj){var cta_name=obj.cta_name,form=obj.elForm,form_id=form.getAttribute('id'),cta_id=form_id+'-'+cta_name,cta_input=Y.one('#'+cta_id);try{cta_input.set('value',obj.cta_value.toLowerCase());}catch(e){Y.log('Error finding cta_input: '+e,'error','FantasyFormEnhancer.updateHiddenInputValue');}},handleCTAClick:function(e,obj){e.preventDefault();var id=e.currentTarget.get('id'),isDisabled=Y.one('#'+id).hasClass(this.ext+'-cta-disabled'),form=obj.elForm,form_id=form.getAttribute('id'),cta_type=obj.cta_type;if(isDisabled){return false;}
try{switch(cta_type){case'reset':if(Y.Fantasy.FantasyFormEnhancer.fireFormReset(form_id,obj)){return true;}
break;case'button':if(Y.Fantasy.FantasyFormEnhancer.fireFormButton(form_id,obj)){return true;}
break;case'submit':Y.Fantasy.FantasyFormEnhancer.updateHiddenInputValue(obj);if(Y.Fantasy.FantasyFormEnhancer.fireFormSubmit(form_id,obj)){return true;}
break;default:Y.log('Executing default case in handleCTAClick. This may be unintentional.','warning','FantasyFormEnhancer');Y.Fantasy.FantasyFormEnhancer.updateHiddenInputValue(obj);if(Y.Fantasy.FantasyFormEnhancer.fireFormSubmit(form_id,obj)){form.submit();return true;}else{return false;}}}catch(e){Y.log('Error in handleCTAClick: '+e,'error','Fantasy.FantasyFormEnhancer.handleCTAClick');}},handleFormKeyup:function(e,obj){var form_id=form.get('id'),keycode=e.charCode;if(keycode===13){Y.Fantasy.FantasyFormEnhancer.updateHiddenInputValue(obj);if(Y.Fantasy.FantasyFormEnhancer.fireFormSubmit(form_id,obj)){form.submit();return true;}}
return false;},fireFormSubmit:function(form_id,obj){return this.fireFormCustomEvent(form_id,obj,'submit');},fireFormReset:function(form_id,obj){return this.fireFormCustomEvent(form_id,obj,'reset');},fireFormButton:function(form_id,obj){return this.fireFormCustomEvent(form_id,obj,'button');},fireFormCustomEvent:function(form_id,obj,evt){var success=true;if(this.formEvtMap[form_id]&&this.formEvtMap[form_id][evt]){success=this.fire(evt,{form:Y.one('#'+form_id)});}
return success;}};Y.augment(FantasyFormEnhancer,Y.EventTarget,true,null,{emitFacade:true});Y.Fantasy.FantasyFormEnhancer=new FantasyFormEnhancer();},'0.1',{'requires':['event','event-custom']});