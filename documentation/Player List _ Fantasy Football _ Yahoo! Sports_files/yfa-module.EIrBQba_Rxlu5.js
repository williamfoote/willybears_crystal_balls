
YUI.add('yfa-module',(function(){var modules={};return function(Y){var evEventPrefix='yfamodule',EV_DISPLAYUPDATE='yfamodule:displayudpate',EV_SWITCHTAB='yfamodule:switchtab',EV_CHANGESELECT='yfamodule:changedModSelect',EV_TABSELECTED='yfamodule:tabselected',EV_DATARECEIVED='yfamodule:datareceived';function YFAModule(cfg){YFAModule.superclass.constructor.apply(this,arguments);}
YFAModule.NAME='yfamodule';YFAModule.ATTRS={'el':{'value':null,'setter':function(val,fullname){return Y.one(val);}},'callbackObj':{'value':{'success':function(cId,response){var target=this.targets[cId],respObj=this.parseResponse(cId,response),content,destinationEl,contentHTML;if(this.getErrors(cId)){Y.log(this.getErrors(cId),'warn','yfa-module');}else if(respObj.contentIsNew){contentHTML=Y.Fantasy.Mod.cleanupHtml(respObj.content);content=Y.Node.create(contentHTML);destinationEl=this.insertContent(content,target);this.processModSelect(cId,respObj.objects);this.processBadge(cId,respObj.objects);this.processModHide(cId,respObj.objects);if(destinationEl){this.cacheContent(Y.Fantasy.XHR.getTransaction(cId),destinationEl);this.updateModuleDisplay(destinationEl);}}else{Y.log('Content hasn\'t change, won\'t refresh module');}
if(Y.Lang.isArray(respObj.objects)&&respObj.objects.length){this.fire(EV_DATARECEIVED,{objects:respObj.objects});}
this.refreshFlyoutSelect();},'failure':function(cId,response){var failCount=this.get('failedRequestCount')||0,failThresh=this.get('failedRequestThreshold');Y.log('failure handler called on connection '+cId,'error','yfa-module');failCount+=1;if(failCount>failThresh){this.destroyRefresh();}
this.set('failedRequestCount',failCount);}}},'triggerHandler':{'value':function(e,obj){if(this.ancestor('.orphan')){return;}
var doPreventDefault=false,connection,targetNode=null,nav=this.ancestor('[data-dynamic]'),href=this.getAttribute('href'),re=/^\#/,target,isDynamic=false,forceRefresh=false,eventPayload={'func':null},liAncestor,fn;liAncestor=this.ancestor('li');if(this.hasAttribute('data-href')){href=this.getData('href');}else if(this.hasAttribute('data-href-current')){href=window.location.href;}
if(this.hasClass('yfa-dynamic')){nav=this;isDynamic=true;forceRefresh=true;}else if(nav){if(nav.getAttribute('data-dynamic')==='true'){isDynamic=true;}
if(nav.getAttribute('data-nocache')==='true'||(liAncestor&&liAncestor.getAttribute('data-nocache')==='true')){forceRefresh=true;}}else{obj.switchTab(liAncestor,nav);}
if(isDynamic){target=this.hasAttribute('data-target')?this.getAttribute('data-target'):nav.getAttribute('data-target');targetNode=target?obj.get('el').one(target):null;if(targetNode!==null&&!forceRefresh){doPreventDefault=obj.loadCachedContent(this,target);}
fn=function(){var connection=obj.fetch(this,href);if(connection){obj.switchTab(liAncestor,nav);obj.targets[connection.id]=target;}};eventPayload.func=Y.bind(fn,this);eventPayload.isPrevented=false;eventPayload.module=obj.get('el');eventPayload.displayTarget=target;if(!doPreventDefault){doPreventDefault=true;obj.fire(EV_SWITCHTAB,eventPayload);}else{obj.switchTab(liAncestor,nav);}}else{var selector=href;if(this.hasAttribute('data-target')&&!re.test(selector)){selector=this.getAttribute('data-target');}
obj.switchTab(liAncestor,nav);if(re.test(selector)){if(obj.get('el').one(selector)){doPreventDefault=obj.updateModuleDisplay(obj.get('el').one(selector));}}}
if(doPreventDefault&&e&&Y.Lang.isFunction(e.preventDefault)&&this.getData('prevent-default')!='false'){e.preventDefault();}}},'cacheTTL':{value:5*60*1000},'failedRequestCount':{value:0},'failedRequestThreshold':{value:10}};Y.extend(YFAModule,Y.Fantasy.XHR,{_createEvents:function(){var self=this;this.publish(EV_DISPLAYUPDATE,{queuable:false,emitFacade:true,bubbles:true,broadcast:2,prefix:evEventPrefix});this.publish(EV_TABSELECTED,{queuable:false,emitFacade:true,bubbles:true,broadcast:2,prefix:evEventPrefix});this.publish(EV_SWITCHTAB,{queuable:false,emitFacade:true,defaultFn:self._doNothing,preventedFn:self._doNothing,preventable:true,bubbles:true,bubbleEvents:true,broadcast:2,prefix:evEventPrefix});this.publish(EV_DATARECEIVED,{queuable:false,emitFacade:true,preventable:true,bubbles:true,bubbleEvents:true,broadcast:2,prefix:evEventPrefix});this.after(EV_SWITCHTAB,self._execEvtPayload);},_execEvtPayload:function(ev){ev.func();},_doNothing:function(ev){return;},register:function(){var el=this.get('el'),self=this;modules[el]=self;el.delegate('click',self.get('triggerHandler'),'.Navitem:not(.Js-static) > .Navtarget:not(.Js-static), a.yfa-dynamic',null,self);el.delegate('click',self.modToggleHandler,'.Btn-mod-toggle',null,self);el.delegate('change',self.handleModSelectChange,'select[data-dynamic=true]',null,self);this._createEvents();this.set('isRegistered',true);this.cacheInitialContent();this.initRefresh();this.refreshFlyoutSelect();},_flyoutSelect:null,initFlyoutSelect:function(flyout){var fl=new Y.Fantasy.FlyoutSelect({'el':flyout,'trigger_classes':'Btn Btn-short Fz-xs Grid-u','ul_classes':'Nav-v Nav-plain Dropdown Nowrap No-p Box-shadow Bdr-radius Bdr','use_link':true,'title_changed_listener':EV_CHANGESELECT});this._flyoutSelect=fl;},refreshFlyoutSelect:function(){var modSelect=this._getModSelect(),flyout;if(modSelect){flyout=modSelect.ancestor('.Flyoutselectbox');}
if(flyout){if(this._flyoutSelect){this._flyoutSelect.destroy();}
this.initFlyoutSelect(flyout);}},modToggleHandler:function(e,obj){e.preventDefault();if(e.target.test('.Btn-mod-toggle')){modToggle=Y.one('.Mod-toggle');if(modToggle.hasClass('Hidden')){modToggle.removeClass('Hidden');if(e.target.test('.Btn-mod-toggle')){e.target.addClass('Hidden');}}else{modToggle.addClass('Hidden');Y.one('form textarea').set('value',null);Y.one('.Btn-mod-toggle').removeClass('Hidden');}}},initRefresh:function(){var module=this.get('el'),refreshLinks,self=this;this.destroyRefresh();refreshLinks=module.all('.yfa-dynamic[data-refresh]');if(refreshLinks.size()){Y.some(refreshLinks,function(n){var refreshTime=parseInt(n.getAttribute('data-refresh'),10),isSubmod,isHidden=false;isSubmod=n.ancestor('.Submod');if(isSubmod){isHidden=(isSubmod.getComputedStyle('display')==='none');}
if(isHidden){return false;}
if(refreshTime){self._refresh=Y.later(refreshTime,n,self.get('triggerHandler'),[null,self],true);if(!self._refreshLimit){self._refreshLimit=Y.later(refreshTime*5000,self,self.destroyRefresh);}
this.set('failedRequestCount',0);return true;}});}
if(Y.Lang.isFunction(Y.Fantasy.RegEditSettings)){Y.Fantasy.RegEditSettings.init();}},destroyRefresh:function(){if(this._refresh&&Y.Lang.isFunction(this._refresh.cancel)){this._refresh.cancel();}
this._refresh=null;},_refresh:null,_refreshLimit:null,updateModuleDisplay:function(destination){var el=this.get('el'),destinationEl,focusEl,sibs;destinationEl=(Y.Lang.isString(destination))?el.one(destination):destination;focusEl=destinationEl;if(focusEl){sibs=focusEl.siblings('.Submod');sibs.removeClass('Selected');focusEl.addClass('Selected');this.fire(EV_DISPLAYUPDATE,{'module':el,'displayTarget':focusEl});this.initRefresh();return true;}else{this.initRefresh();}
return false;},switchTab:function(tabEl,navEl){if(!tabEl){return;}
var siblings=tabEl.siblings(),supernav,subnav,supernavEl,subnavEl,subnavElSelected;tabEl.addClass('Selected');siblings.removeClass('Selected');Y.fire(EV_TABSELECTED,{'tab':tabEl});if(navEl){supernav=navEl.getData('supernav-target');supernavEl=(supernav)?Y.one(supernav):null;if(supernavEl){if(!supernavEl.hasClass('Navitem')){supernavEl=supernavEl.ancestor('.Navitem');}
if(supernavEl){this.switchTab(supernavEl);}}
if(tabEl.one('.Navtarget')){subnav=tabEl.one('.Navtarget').getData('subnav-target');subnavEl=(subnav)?Y.one(subnav):null;subnavElSelected=(subnavEl)?subnavEl.one('.Navitem.Default-selected'):null;if(subnavElSelected){this.switchTab(subnavElSelected);}else if(subnavEl){subnavEl.all('.Navitem.Selected').removeClass('Selected');}}}},handleModSelectChange:function(e,obj){var target=this.getAttribute('data-target'),targetNode=target?obj.get('el').one(target):null,fn,eventPayload={},href,re=/^http(s)?:\/\//;href=this.get('value');const targetInputName=this.getAttribute('data-radio-input-target');if(targetInputName){const targetInputNodes=document.querySelectorAll('input[name="'+targetInputName+'"]');const targetInputsArray=targetInputNodes?Array.prototype.slice.call(targetInputNodes):null;const checkedInput=targetInputsArray?targetInputsArray.filter(function(node){return node.checked;}).shift():null;if(checkedInput){const checkedInputValue=checkedInput.value;href=href+'&selected_value='+checkedInputValue;}}
if(re.test(href)){document.location.href=href;}
if(targetNode&&href){fn=function(){var connection=obj.fetch(this,href);if(connection){obj.targets[connection.id]=target;}};eventPayload.func=Y.bind(fn,this);eventPayload.isPrevented=false;obj.fire(EV_SWITCHTAB,eventPayload);}},insertContent:function(content,target){var module=this.get('el'),targetEl,destinationEl=null,targetInContent;targetEl=module.one(target);if(targetEl){if(content.one(target)){targetEl.setHTML(content.one(target).getHTML());}else{targetEl.setHTML(content);}
destinationEl=targetEl;}else{targetInContent=content.one(target);if(targetInContent&&targetInContent.hasClass('Submod')){if(module.one('.Js-submods')){module.one('.Js-submods').append(targetInContent);destinationEl=targetInContent;}}}
if(destinationEl){this.initRefresh();}
return destinationEl;},_modSelect:false,_getModSelect:function(){var el=this.get('el');if(el){var modSelect=el.one('.Mod-select');if(modSelect){this._modSelect=modSelect;}}
return this._modSelect;},processModSelect:function(cId,respObjects){var sel=this._getModSelect(),newOptTemplate,hideSel=true;if(sel){Y.Array.some(respObjects,function(obj){if(obj.selectitems&&Y.Lang.isArray(obj.selectitems)){newOptTemplate=Y.Node.create('<option value=\'\'></option>');sel.empty();Y.Array.each(obj.selectitems,function(selectitem){var newOpt=newOptTemplate.cloneNode();newOpt.set('value',selectitem.target);newOpt.set('text',selectitem.label);if(selectitem.selected){newOpt.setAttribute('selected',selectitem.selected);}
if(selectitem.next){newOpt.setAttribute('next',selectitem.next);}
if(selectitem.prev){newOpt.setAttribute('prev',selectitem.prev);}
sel.append(newOpt);});hideSel=false;return true;}});Y.Array.some(respObjects,function(obj){if(obj.selecttarget){sel.setAttribute('data-target',obj.selecttarget);return true;}});if(hideSel){sel.addClass('Js-hidden');sel.ancestor('.Selectbox').addClass('Js-hidden');}else{sel.removeClass('Js-hidden');sel.ancestor('.Selectbox').removeClass('Js-hidden');}
Y.fire(EV_CHANGESELECT,{hidden:sel.ancestor('.Selectbox').hasClass('Js-hidden'),select:sel});}},processBadge:function(cId,respObjects){Y.Array.some(respObjects,function(obj){if(obj.badges&&Y.Lang.isArray(obj.badges)){Y.Array.each(obj.badges,function(badge){if(badge.name!==undefined&&badge.value!==undefined){var badgeList=Y.all('[data-badge-name='+badge.name+']');badgeList.each(function(badgeEl){if(parseInt(badge.value,10)===0){badgeEl.addClass('Hidden');}else{badgeEl.setHTML(badge.value);badgeEl.removeClass('Hidden');}});}});}});},processModHide:function(cId,respObjects){var mod=this.get('el');Y.Array.some(respObjects,function(obj){if(obj.hideMod&&obj.hideMod===true){mod.addClass('Hidden');}});},_cacheSharedTargetContent:function(nav,target){var selectedNavTab,targetEl;selectedNavTab=nav.one('.Selected a');targetEl=this.get('el').one(target);if(selectedNavTab&&targetEl){this.cacheContent(selectedNavTab,targetEl);}},_cacheNavItemTargetContent:function(nav){var navItems=nav.all('a'),self=this;navItems.each(function(navItem){var target,targetEl;target=navItem.getAttribute('data-target');if(target){targetEl=self.get('el').one(target);}
if(targetEl){self.cacheContent(navItem,targetEl);}},self);},cacheInitialContent:function(){var navs,el,self=this;el=this.get('el');navs=el.all('.Nav-h, .Nav-v');navs.each(function(nav){var target,dynamic;target=nav.getAttribute('data-target');dynamic=nav.getAttribute('data-dynamic')==='true'?true:false;if(dynamic){if(target){self._cacheSharedTargetContent(nav,target);}else{self._cacheNavItemTargetContent(nav);}}},self);},cacheContent:function(node,content){var href=node.getAttribute?node.getAttribute('href'):false,self=this,modSelect=this._getModSelect();if(href){this.urlCache[href]=content.getHTML();Y.later(this.get('cacheTTL'),self,function(){this.urlCache[href]=false;});if(modSelect){this.selectCache[href]=modSelect.cloneNode(true);}}},loadCachedContent:function(url,target){var href=Y.Lang.isString(url)?url:url.getAttribute&&url.getAttribute('href'),content;if(href){content=this.urlCache[href]||false;}
if(content){this.insertContent(Y.Node.create(content),target);this.updateModuleDisplay(target);this.loadCachedSelect(href);return true;}
return false;},loadCachedSelect:function(href){var sel=this._getModSelect(),cachedSel,cachedSelClone;if(sel){cachedSel=this.selectCache[href];if(cachedSel){cachedSelClone=cachedSel.cloneNode(true);sel.replace(cachedSelClone);this._modSelect=cachedSelClone;if(this._modSelect.hasClass('Js-hidden')){this._modSelect.ancestor('.Selectbox').addClass('Js-hidden');}else{this._modSelect.ancestor('.Selectbox').removeClass('Js-hidden');}
this.refreshFlyoutSelect();Y.fire(EV_CHANGESELECT,{hidden:cachedSelClone.ancestor('.Selectbox').hasClass('Js-hidden'),select:this._modSelect});}}},urlCache:{},targets:{},selectCache:{}},{reload:function(selector){var mod=Y.Fantasy.Mod.getModule(selector);if(mod){var el=mod.get('el');var selectedTab=el.one('.Navitem.Selected a');if(selectedTab){var fn=mod.get('triggerHandler');var method=(selectedTab&&Y.Lang.isString(fn))?selectedTab[fn]:fn;if(!method.apply){method(null,mod);}else{method.apply(selectedTab,[null,mod]);}
return true;}}
return false;},getModule:function(selector){var el=Y.one(selector);if(el){return modules[el];}
return undefined;},cleanupHtml:function(html){if(Y.UA.ie&&Y.UA.ie<9){html=html.replace(/<(\/?)(section|article|nav)/g,'<$1div');}
return html;}});Y.namespace('Fantasy');Y.Fantasy.Mod=YFAModule;};})(),'0.1',{'requires':['ysf-xhr','node','node-event-delegate','selector-css3','base','ysf-flyout-select']});