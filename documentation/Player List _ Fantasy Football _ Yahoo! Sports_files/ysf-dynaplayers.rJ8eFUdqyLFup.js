
YUI.add('ysf-dynaplayers',function(Y){Y.Fantasy.DynaPlayers=Y.Base.create('DynaPlayers',Y.Widget,[],{_handles:{},_origAsset:null,_adPositions:['REC','HB'],initializer:function(){var oMod=this,selfPopulate=oMod.get('selfPopulate'),oHistory=oMod.get('oHistory');if(selfPopulate){oMod.getPlayers();return;}
oMod.initNodes();oMod.bind();Y.each(oMod._adPositions,function(v,i,a){YUI.Sports.Ads.registerAd(v,'yspad'+v);});oMod.addTarget(Y.Global);},initNodes:function(){var oMod=this,ctaStrings;if(Y.one('#fantasy')){ctaStrings={classes:{'cta':'Btn-primary','save':'ysf-cta-save','reset':'ysf-cta-reset','cancel':'ysf-cta-cancel','done':'ysf-cta-done','proceed':'ysf-cta-proceed','cta_disabled':'ysf-cta-disabled'}};}else{ctaStrings={classes:{'cta':'ysf-cta','save':'ysf-cta-save','reset':'ysf-cta-reset','cancel':'ysf-cta-cancel','done':'ysf-cta-done','proceed':'ysf-cta-proceed','cta_disabled':'ysf-cta-disabled'}};}
oMod.set('searchForm',(function(){var oForm=new Y.Fantasy.Form({contentBox:'#playersearch form',strings:ctaStrings});oForm.render();return oForm;})()).set('searchNode',(function(){var searchForm=oMod.get('searchForm'),searchNode=(searchForm)?searchForm.get('formNode').one('input.playersearch_ac'):null;return searchNode;})()).set('filterForm',(function(){var oForm=new Y.Fantasy.Form({contentBox:'#playerfilter form',strings:ctaStrings}),formNode=oForm.get('formNode');formNode.setAttribute('data-players-action',formNode.get('action'));oForm.render();return oForm;})()).set('playerNode',(function(){var srcNode=oMod.get('srcNode'),playerNode=null;srcNode=srcNode||Y.one('body');if(Y.one('#fantasy')){playerNode=srcNode.one('#players-table-wrapper');}else{playerNode=srcNode.one('#players-table');}
if(playerNode){var anchorNode=playerNode.one('thead th.sorted a'),orig_href=null;if(anchorNode){orig_href=anchorNode.get('href');oMod.set('lastNonSearchIOAsset',orig_href);oMod._origAsset=orig_href;}}
return playerNode;})()).set('pageNodes',(function(){return oMod.get('playerNode').all('.pagingnav');})());},bind:function(){var oMod=this,searchForm=oMod.get('searchForm'),filterForm=oMod.get('filterForm'),playerNode=oMod.get('playerNode'),oHistory=oMod.get('oHistory');oMod._handles.onSearchFormProceed=searchForm.on('proceed',Y.bind(oMod.onSearchFormSubmit,oMod),oMod,searchForm);oMod._handles.onSearchFormSubmit=searchForm.on('submit',Y.bind(oMod.onSearchFormSubmit,oMod),oMod,searchForm);oMod._handles.onFilterFormProceed=filterForm.on('proceed',Y.bind(oMod.onFilterFormProceed,oMod),oMod,filterForm);oMod._handles.onFilterClick=playerNode.delegate('click',Y.bind(oMod.onFilterClick,oMod),'table thead a');oMod._handles.onPagingClick=playerNode.delegate('click',Y.bind(oMod.onFilterClick,oMod),'.pagingnav li a');oMod._handles.onPlayerSearchClear=Y.Global.on('YSFPlayerSearch:clear',Y.bind(oMod.onPlayerSearchClear,oMod));oMod._handles.afterPlayerSearchSelect=Y.Global.after('YSFPlayerSearch:select',Y.bind(oMod.afterPlayerSearchSelect,oMod));oMod._handles.afterIOAssetChange=oMod.after('ioAssetChange',Y.bind(oMod.afterIOAssetChange,oMod));oMod._handles.onHistoryChange=oHistory.on('change',Y.bind(oMod.onHistoryChange,oMod));},onSearchFormSubmit:function(e,formObj){var oMod=this;if(!oMod.get('disabled')){e.halt();oMod.set('searchView',true);oMod.set('ioAsset',formObj);}},onFilterFormProceed:function(e,formObj){e.halt();var oMod=this;oMod.set('ioAsset',formObj);},onFilterClick:function(e){e.halt();var oMod=this,anchorNode=e.currentTarget;oMod.set('ioAsset',anchorNode.get('href'));var MAX_LEN=30,tg=e.target,moduleName=tg.getData('sec')||'',linkName=tg.getData('slk')||tg.getContent()||'',clickParams=tg.getData('clickParams')?JSON.parse(tg.getData('clickParams')):{};if(clickParams.ll1&&clickParams.ll1.indexOf('%')>=0){clickParams.ll1=clickParams.ll1.replace('%','Pct');}
Y.Fantasy.rapid.beaconClick(moduleName.substring(0,MAX_LEN),linkName.substring(0,MAX_LEN),0,clickParams);},onPlayerSearchClear:function(e){var oMod=this;if(oMod.get('searchView')&&Y.Node.getDOMNode(e.inputNode)===Y.Node.getDOMNode(oMod.get('searchNode'))){oMod.set('searchView',false);oMod.set('ioAsset',oMod.get('lastNonSearchIOAsset'));oMod.onSearchFormSubmit(e,oMod.get('searchForm'));}},afterPlayerSearchSelect:function(e){var oMod=this;oMod.set('searchView',true);oMod.set('ioAsset',oMod.get('searchForm'));},onHistoryChange:function(e){var oMod=this;if(e.src!==Y.HistoryBase.SRC_ADD&&e.newVal&&e.newVal.psh){oMod.set('searchView',(e.newVal.psh.indexOf('playersearch')!==-1));if(e.changed.psh){oMod.getPlayers(e.newVal.psh,false);}else if(e.removed.psh){oMod.getPlayers(oMod._origAsset,false);}}},_onIOSuccess:function(i,o,args){var oMod=this;try{var response=Y.JSON.parse(o.responseText),errors=response.errors,ioAsset=args.ioAsset,add_history=args.add_history,form_serialized=args.form_serialized,history_string='',space_id;if(errors.length===0){var newNode=Y.Node.create('<div></div>');oHistory=oMod.get('oHistory');newNode.setHTML(response.content);if(!oMod.get('selfPopulate')){oMod.updateTable(newNode);oMod.updatePageNodes(newNode);oMod.updateFilterForm(newNode);}else{oMod.get('srcNode').setContent(newNode);Y.Fantasy.InitLinks.init(Y.Node.getDOMNode(oMod.get('srcNode')));oMod.set('selfPopulate',false);oMod.initializer();oMod.fire('selfPopulate');}
if(oMod.get('searchView')){Y.io(YSF.Fantasy.League.uri+'/playersearch_dynamic_view');space_id=YUI.Fantasy.SpaceIds.getSpaceId('playersearch');}else{oMod.set('lastNonSearchIOAsset',ioAsset);Y.io(YSF.Fantasy.League.uri+'/players_dynamic_view');space_id=YUI.Fantasy.SpaceIds.getSpaceId('playernote');}
YSF.use('ysp-i13n',function(Y){if(typeof(YSF.sendComscoreEvent)==='function'){YSF.sendComscoreEvent(space_id,encodeURIComponent(document.location.href));}});if(add_history){if(form_serialized===''){history_string=Y.Fantasy.DynaPlayers.cleanURlString(ioAsset).replace(location.protocol+'//'+location.host,'');}else{history_string=Y.Fantasy.DynaPlayers.cleanURlString(ioAsset.get('formNode').get('action')).replace(location.protocol+'//'+location.host,'')+'&'+form_serialized;}
oHistory.addValue('psh',history_string,{url:history_string});}
oMod.refreshAds();oMod.fire('refresh');}else{var oRedirectErrors={'e373':true,'e710':true};Y.each(errors,function(v,i,a){alert(v.title.replace('&nbsp;',' '));if(!Y.Lang.isUndefined(oRedirectErrors['e'+v.code])&&oRedirectErrors['e'+v.code]){if(Y.Lang.isString(ioAsset)){document.location=ioAsset;}else{oMod.set('disabled',true);ioAsset.submit();}}});}}catch(e){Y.log('io fail:');Y.log(e);}
oMod.set('lastIOTx',null);},_onIOFailure:function(i,o,args){},_onIOEnd:function(i,args){},afterIOAssetChange:function(e){var oMod=this;if(e.newVal){oMod.getPlayers();}},getPlayers:function(ioAsset,add_history){var oMod=this,ioUrl='',selfPopulate=oMod.get('selfPopulate'),lastIOTx=oMod.get('lastIOTx'),tx=null,cfg={'headers':{'Ajax-Request':'true'}},form_serialized='';add_history=Y.Lang.isBoolean(add_history)?add_history:true;ioAsset=(ioAsset)?ioAsset:oMod.get('ioAsset');if(lastIOTx){lastIOTx.abort();oMod.set('lastIOTx',null);}
if(ioAsset&&!Y.Lang.isString(ioAsset)){var formNode=ioAsset.get('formNode');if(!oMod.get('searchView')&&(ioAsset===oMod.get('filterForm'))){formNode=oMod.get('filterForm').get('formNode');formNode.set('action',formNode.getAttribute('data-players-action'));}
ioUrl=formNode.get('action');cfg.form={};cfg.form.id=formNode;cfg.method='GET';form_serialized=Y.IO.prototype._serialize(cfg.form);}else if(Y.Lang.isString(selfPopulate)){ioUrl=selfPopulate;}else{ioUrl=ioAsset;}
if(ioUrl&&ioUrl!==''){cfg.on={'success':oMod._onIOSuccess,'failure':oMod._onIOFailure,'end':oMod._onIOEnd};cfg.context=oMod;cfg.arguments={ioAsset:ioAsset,add_history:add_history,form_serialized:form_serialized};tx=Y.io(ioUrl,cfg);oMod.set('lastIOTx',tx);}},updateTable:function(newNode){var oMod=this,playerNode=oMod.get('playerNode'),targetNode=playerNode.one('.players'),newTargetNode=newNode.one('.players');targetNode.get('children').destroy(true);if(newTargetNode){targetNode.replace(newTargetNode);Y.Fantasy.InitLinks.init(Y.Node.getDOMNode(newTargetNode));}},updatePageNodes:function(newNode){var oMod=this,pageNodes=oMod.get('pageNodes'),matchNodes=newNode.all('.pagingnav'),matchNode=null;pageNodes.each(function(n,i,nl){matchNode=matchNodes.item(i);if(matchNode){n.setContent(matchNode.getContent());}else{n.get('children').remove(true);}});},updateFilterForm:function(newNode){var oMod=this,filterFormNode=oMod.get('filterForm').get('formNode'),targetFormNode=newNode.one('#playerfilter form'),selectsNode=filterFormNode.one('div.selects'),targetNode=newNode.one('#playerfilter form div.selects');if(targetFormNode&&targetNode){filterFormNode.set('action',targetFormNode.get('action'));selectsNode.setContent(targetNode.getContent());}},refreshAds:function(){var oMod=this,positions='',page=(oMod.get('searchView'))?'playersearch':'players';Y.each(oMod._adPositions,function(v,i,a){positions+=v;if((i+1)<a.length){positions+=',';}});YUI.Sports.Ads.subscribe(null,'now',{'tablerefresh':{lv:1,npv:true,sp:YUI.Fantasy.SpaceIds.getSpaceId(page),ps:positions}});},destructor:function(){var oMod=this,searchForm=oMod.get('searchForm'),filterForm=oMod.get('filterForm');for(h in oMod._handles){oMod._handles[h].detach();oMod._handles[h]=null;delete oMod._handles[h];}
if(searchForm){searchForm.destroy();}
if(filterForm){filterForm.destroy();}}},{ATTRS:{'searchForm':{value:null},'searchNode':{value:null},'filterForm':{value:null},'playerNode':{value:null},'pageNodes':{value:null},'ioAsset':{value:(YSF)?YSF.Fantasy.League.uri+'/players':null},'lastIOTx':{value:null},'lastNonSearchIOAsset':{value:null},'oHistory':{valueFn:function(){return new Y.History();}},'selfPopulate':{value:false},'searchView':{value:false}},cleanURlString:function(str){if(str.indexOf('#')>-1){str=str.split('#')[0];}
if(str.indexOf('?')<0){str+='?';}
return str;}});},'',{'requires':['ysf-form','ysf-ads','base-build','widget-base','node-event-delegate','io-form','json-parse','history','ysf-initlinks']});