
YUI.add('ysf-playersearch-plugin',(function(){var oLocalDS={},current_qs=null,current_source=null,xhr_in_progress=false,xhr_source=null;return function(Y){Y.namespace('Fantasy.Plugin');var sanitizeQuery=function(s){return Y.Lang.trim(s.replace(/[^a-zA-ZÁÉÍÓÚáéíóúÀÈÌÒÙàèìòùÂÊÎÔÛâêîôûÃÑÕãñõÄËÏÖÜŸäëïöüÿ \']+/gi,'').toLowerCase());},resultFilter=function(q,a){var aResults=[],result='',last_result='',x=0;rQueryUTF8=new RegExp(checkCharMap(UTF8decode(unescape(q))),'gi');Y.some(a,function(v,i,arr){result=v.raw.sPlayerName;if(Y.Lang.isString(result)&&result.match(rQueryUTF8)){if(last_result!==result){aResults.push(v);x++;last_result=result;}}});return aResults;},resultTextLocator=function(r){return r.sPlayerName;},resultListLocator=function(a,b){if(Y.Lang.isArray(a)){return a;}else if(Y.Lang.isArray(a.objects)&&!Y.Lang.isUndefined(a.objects[0].aResult)){oLocalDS[current_qs]={};oLocalDS[current_qs].aResult=a.objects[0].aResult;oLocalDS[current_qs].aCharMap='';return oLocalDS[current_qs].aResult;}},requestTemplate=function(s){return sanitizeQuery(s).substring(0,1);},checkCharMap=function(s){var cur_charMap=oLocalDS[current_qs].aCharMap;if(Y.Lang.isArray(cur_charMap)&&cur_charMap.length){var j=cur_charMap.length,loc=-1,sReg,oReg;while(j--){loc=s.indexOf('['+cur_charMap[j].substring(0,1));if(loc>=0){s=s.replace('['+cur_charMap[j].substring(0,1),'['+cur_charMap[j]);}else{sReg='['+cur_charMap[j]+']{1}';oReg=new RegExp(sReg,'g');s=s.replace(oReg,sReg);}}}
return s;},UTF8decode=function(s){s=sanitizeQuery(s);for(var a,b,i=-1,l=(s=s.split('')).length,o=String.fromCharCode,c='charCodeAt';++i<l;((a=s[i][c](0))&0x80)&&(s[i]=(a&0xfc)==0xc0&&((b=s[i+1][c](0))&0xc0)==0x80?o(((a&0x03)<<6)+(b&0x3f)):o(128),s[++i]='')){;}
return s.join('');};Y.Fantasy.Plugin.PlayerSearch=Y.Base.create('YSFPlayerSearch',Y.Plugin.AutoComplete,[],{_handles:{},initializer:function(){var oPlug=this;oPlug.publish('clear',{'broadcast':2});oPlug.addTarget(Y.Global);xhr_source=YSF.Fantasy.League.uri+'/playersearchservice?q={query}';},render:function(){Y.Fantasy.Plugin.PlayerSearch.superclass.render.call(this);var oPlug=this;if(!oPlug.get('isWebkitSearchfield')){oPlug.renderClearButton();}
oPlug.set('zIndex',10);oPlug.bind();oPlug.sync();},renderClearButton:function(){var oPlug=this,clearNode=Y.Node.create('<a href="#" class="Inline Fl-start F-shade Mtop-sm F-icon Fz-med '+oPlug._cssPrefix+'-clear" style="display:none;">'+oPlug.get('inputNode').getAttribute('data-closeicon')+'</a>');oPlug.set('clearNode',clearNode);oPlug.get('inputNode').insert(clearNode,'after');},bind:function(){var oPlug=this;oPlug._handles.beforeValueChange=oPlug.before('valueChange',Y.bind(oPlug.beforeValueChange,oPlug));oPlug._handles.beforeQuery=oPlug.before('query',Y.bind(oPlug.beforeQuery,oPlug));oPlug._handles.afterResultsChange=oPlug.after('resultsChange',Y.bind(oPlug.afterResultsChange,oPlug));oPlug._handles.afterSelect=oPlug.after('select',Y.bind(oPlug.afterSelect,oPlug));oPlug._handles.onEscPress=Y.on('key',Y.bind(oPlug.onEscPress,oPlug),oPlug.get('inputNode'),'up:27');if(!oPlug.get('isWebkitSearchfield')){oPlug._handles.onNullValueChange=oPlug.on('valueChange',Y.bind(oPlug.onNullValueChange,oPlug));oPlug._handles.onClearButtonClick=oPlug.get('contentBox').ancestor('.playersearchbox').delegate('click',Y.bind(oPlug.onClearButtonClick,oPlug),'a.'+oPlug._cssPrefix+'-clear');}
oPlug._handles.onReturnPress=Y.on('key',Y.bind(oPlug.afterSelect,oPlug),oPlug.get('inputNode'),'down:13');oPlug.get('inputNode').focus();},afterSelect:function(e){var oPlug=this;oPlug.get('contentBox').ancestor('form').submit();},beforeQuery:function(e){current_qs=sanitizeQuery(e.query).substring(0,1);if(current_source===xhr_source){xhr_in_progress=true;}},beforeValueChange:function(e){var oPlug=this,newVal=(e.newVal)?sanitizeQuery(e.newVal).substring(0,1):'';if(!!!newVal){Y.later(0,{},function(){oPlug.hide();oPlug.fire('clear',{'inputNode':oPlug.get('inputNode')});});e.halt();return;}else if(xhr_in_progress){e.halt();return;}
if(!Y.Lang.isUndefined(oLocalDS[newVal])&&(current_source!==oLocalDS[newVal])){oPlug.set('source',oLocalDS[newVal].aResult);current_source=oLocalDS[newVal].aResult;}else if(!xhr_in_progress&&Y.Lang.isUndefined(oLocalDS[newVal])){oPlug.set('source',xhr_source);current_source=xhr_source;}},afterResultsChange:function(e){var oPlug=this;if(current_source===xhr_source){if(!Y.Lang.isUndefined(oLocalDS[current_qs])){oPlug.set('source',oLocalDS[current_qs].aResult);current_source=oLocalDS[current_qs].aResult;}
xhr_in_progress=false;Y.later(0,{},function(){var cur_value=oPlug.get('inputNode').get('value');if(cur_value!==''){oPlug.sendRequest(cur_value);}});}},onNullValueChange:function(e){var oPlug=this;if(!!!e.newVal){oPlug.set('clearable',false);}else if(!oPlug.get('clearable')){oPlug.set('clearable',true);}},onClearButtonClick:function(e){e.halt();var oPlug=this;oPlug.set('value','').get('inputNode').set('value','').focus();},onEscPress:function(e){var oPlug=this;oPlug.set('value','').get('inputNode').set('value','').focus();},sync:function(){var oPlug=this;if(oPlug.get('inputNode').get('value')!=''){oPlug.set('clearable',true);}}},{ATTRS:{'source':{'value':xhr_source},'resultFilters':{'value':[resultFilter]},'resultListLocator':{'value':resultListLocator},'resultTextLocator':{'value':resultTextLocator},'requestTemplate':{'value':requestTemplate},'maxResults':{'value':15},'isWebkitSearchfield':{'getter':function(){return(this.get('inputNode').getStyle('webkitAppearance')==='searchfield');}},'clearNode':{'value':null},'clearable':{'value':false,'validator':Y.Lang.isBoolean,'setter':function(v){var oPlug=this,clearNode=oPlug.get('clearNode');if(v){clearNode.setStyle('display','');}else{clearNode.setStyle('display','none');}}}},NS:'playerac'});};})(),'',{'requires':['node-base','event-base','base-build','event-key','autocomplete-sources','autocomplete-plugin','node-event-delegate']});